---
title: 节点/chime-agent的高可用介绍
date: 2023-11-09
weight: 3
---

{{% alert title="提示" color="default" %}}
本章节仅介绍chime-agent如何和chime-server一起工作来实现虚拟机资源的高可用，没有涉及到部署配置的内容，如果您正在部署生产环境，可选择性地忽略本章。
{{% /alert %}}

## chime-agent 高可用介绍

chime-agent进程作为运行在计算节点的守护进程，它接收chime-server下发的指令并对虚拟机的全生命周期进行管控，chime-agent的故障域可以看作等同于节点的故障域，且实现chime-agent的高可用等同于实现运行在该节点上的虚拟机资源的高可用。是ChimeStack整体高可用框架中另外重要的一部分。
ChimeStack为了保证虚拟机状态的一致性，即对于任一运行的虚拟机实例，同一时刻，保证有且仅有一个运行的qemu-kvm进程，并可对其生命周期进行管理控制，简单地说，客户端(计算节点)的高可用要求做到以下三点：
- 虚拟机进程高可用(SLA 99.9%)
- 虚拟机进程的唯一性
- 虚拟机可管控
  
### 架构原理

ChimeStack框架的设计方案主要是中央管控机制，即管控服务进程(chime-server)管理虚拟机的全生命周期，每个虚拟机的状态都会保存在chime-server的数据库中，chime-agent接收chime-server对虚拟机的的管控指令、对chime-server上报心跳、拉取虚拟机信息，下图是chime-agent高可用的示意图： 

![TO-DO](/images/chime-agent-ha.png)

- chime-agent在启动时，会主动向chime-server请求当前计算节点所有未删除的虚拟机的状态以及当前计算节点的状态，并且保存在chime-agent程序的内存中，一旦虚拟机的状态被客户改变，如停机、删除、启动等，chime-agent也会同步更新这个内存数据库。
- chime-agent在运行时，每隔60s就会检查自己运行节点的虚拟机实例(qemu-kvm进程)的运行状态是否和当前内存数据库中的状态保持一致，比如发现某qemu-kvm进程异常退出，chime-agent会自动拉起该qemu-kvm进程。 
- chime-agent在运行时，每隔15s会上报自己的心跳信息，如果chime-server在三个心跳周期没有收到某个chime-agent的心跳信息，会反ping一下该chime-agent，如果确定chime-agent不可达，则会标记为该节点为"不可达"状态，在此状态下，不会再调度新虚拟机到这个节点上，且当前在此节点的虚拟机将不再接收管控命令，同时发出报警信息。如果chime-agent上报心跳成功，则会重新把该节点的状态标记为"运行"，管控指令也恢复正常。
- chime-agent进程的生命周期由linux systemd负责管理，并作为系统的守护进程运行，如果chime-agent进程异常退出，会被systemd自动拉起。

### 节点的状态介绍

节点的状态可分为"管控状态"和"监控状态"两种类型，下面分别介绍这两种状态：

**管控状态**: 即控制面对节点管控用的状态机，可分为以下3种:
- 启用状态(Enabled): 即正常状态，新虚拟机可以调度在该节点上，该节点上既存虚拟机的生命周期由管控面正常管理。
- 停用状态(Disabled): 新的虚拟机不会再调度到该节点上，但该节点上既存虚拟机的生命周期由管控面正常管理。
- 清空状态(Drained): 新的虚拟机不会再调度到该节点上，所有该节点上既存的虚拟机也被停止，即没有虚拟机实例会运行在该节点上。

**监控状态**: 
- 正常状态: chime-agent心跳正常
- 不可达状态: chime-agent不上报心跳，且chime-server无法ping到该chime-agent，此时会发出报警，且新的虚拟机不会调度到该节点上。
- 异常状态: chime-agent检测到节点出现异常，但心跳信息能够正常上报。
  
### 虚拟机高可用方案

为了保证虚拟机的高可用，当节点软件或者硬件出现故障时，可根据故障的不同类型采取不同的处理方式: 

1. 在线迁移：当节点出现非宕机故障，或者节点需要停机维护时，可以通过在线迁移把虚拟机实例在使用者无感知的情况下迁移到其它节点上，具体方法参考 [节点故障的处理方法](/docs/usage/failure)
2. 清空+重建：当节点出现宕机故障时，可以通过对该节点进行"清空"后"重建"的方式把该节点上的虚拟机迁移到其它节点上，具体方法参考 [节点故障的处理方法](/docs/usage/failure)。


## 异常场景方案示例

#### 场景1 计算节点故障宕机

计算节点故障包括电源、CPU、内存、硬盘等硬件的严重故障导致的掉电。针对服务器掉电这种严重异常，运行在服务器上的虚拟机实例也会宕机，操作的目的是尽量减少虚拟机不可用的时间

由于chime-server不会再继续接收到该节点的心跳信息，1分钟内会把该节点的监控状态标记为"不可达"状态，新的虚拟机不会再调度到这个节点上，同时发出报警信息。
管理员查看节点的状态后，可根据故障的不同情况选择不同的处理方式:
- 如果该节点可以恢复，则重新启动该节点后，chime-agent会自动从chime-server拉取该节点所有虚拟机的状态信息，然后自动启动应该运行的虚拟机资源。并且chime-agent恢复心跳后，chime-server会自动标记该节点为监控"正常"状态。
- 如果该节点在短时间内的无法恢复，则管理员可以对该节点进行"清空"操作，清空后即使节点恢复,chime-agent重新上线，也不会启动该节点的虚拟机，对于一个处于"清空"状态的节点，管理员可以选择"重建"操作，即把该节点上的虚拟机在其它节点自动重新部署，在其它节点"重建"成功后，原节点的虚拟机会当chime-agent进程正常启动运行后，被直接删除掉。先进行"清空"在进行"重建"的目的是，保证任意时刻只有一个虚拟机实例在运行，不会发生"脑裂"现象。

#### 场景2 网络故障

网络故障包括网络设备如交换机、网线，或者服务器网卡，以及软件原因造成的网络不可达。

- 管理网不可用，业务网可用: chime-server接收不到chime-agent的心跳信息，只会将节点的监控状态标记为"不可达"，由管理员/运维人员人工确认网络/硬件故障，然后实施操作, 可以通过运维命令"chime-agent migrate --interface <interface name> --uuid <vm uuid> --dest <dest ip>"，其中interface name为业务网网口，dest为业务网目标地址，即通过业务网手动迁移虚拟机当前节点的虚拟机到其它节点，然后通过chime-server标记故障节点为"清空"状态。对于这种情况，客户是对迁移操作无感知的，且虚拟机正常运行。
- 管理网可用、业务网不可用: chime-agent会每30s检测业务网的状态，如果业务网出现问题，chime-agent在向chime-server上报心跳时，会标记计算节点状态为"error"。可以通过运维命令"chime-agent migrate --interface <interface name> --uuid <vm uuid> --dest <dest ip>", 其中interface name为管理网网口，dest为管理网目标地址，即通过管理网手动迁移虚拟机当前节点的虚拟机到其它节点，然后标记故障节点为"清空"状态。对于这种情况，因为业务网络中断，客户对虚拟机的访问是中断的，单虚拟机正常运行。 
- 管理网、业务网均不可用: 此时，chime-server对于该节点的监控状态标记是"不可达",计算节点侧的状态为"error",由于管理网和业务网都不可达，所以无法完成迁移动作，只能通过"清空"后重建该改节点的所有虚拟机实例。但需要注意的是，如果问题节点上的虚拟机实例仍然处于运行状态，需要先运行"chime-agent drain"停止该节点上所有的虚拟机实例防止"脑裂"现象的发生。
  
#### 场景3 chime-agent进程异常

chime-agent进程出现严重异常时，chime-agent进程会异常退出。chime-agent进程的生命周期由systemctl命令管控，并且默认异常策略是故障自动拉起。所以chime-agent进程退出时，会被系统自动地拉起，即可以看作chime-agent进程和计算节点生命周期一致。

#### 场景4 其它非严重硬件故障

大多时候，硬件或软件的一些故障并不会直接导致服务器宕机的严重故障。比如磁盘故障导致的I/O异常、网络设备故障导致的丢包等，由于心跳信息能够正常上报，chime-server会根据故障的类型或标记其监控状态为"异常"。针对这种故障，运维人员需要根据监控报警信息，人工确认后再手动执行运维操作，比如是否需要"迁移"、"清空"及"重建"等操作。 