---
title: 3.6 节点故障的处理方法
weight: 6
description: 本章介绍ChimeStack的节点出现故障的处理方法
---

## 概述

当一个节点由于硬件、软件问题出现异常时，或者需要关机维护时，为了保障虚拟资源服务的可靠性、可用性，需要把节点上运行的虚拟服务(虚拟机实例、虚拟云盘等)迁移到其它功能正常的节点。如下图所示: 

![节点故障迁移](/images/chime-agent-ha.png)

一个节点可采取的运维方法包含:

* **迁移**: 把一个节点上所有的虚拟机资源在用户无感知的基础上迁移到其它节点上，适用场景:
  - 节点非宕机故障时虚拟机迁移
  - 节点维护时虚拟机迁移
* **清空**: 把一个节点上所有运行的虚拟机停止，适用场景:
  - 防止脑裂，在其它节点重建虚拟机前，需要停止该节点虚拟机
  - 节点关机维护
* **重建**: 在其它节点重新创建同样的虚拟机实例，适用场景:
  - 节点宕机故障时虚拟机迁移

下面分别介绍这三种节点故障处理方法。

## 迁移

迁移功能是通过libvirt把虚拟机实例在其运行或者停止状态下，从一个物理节点迁移到另一个物理节点，迁移的过程不影响用户正常使用虚拟机。
迁移可以通过管控面发起，即Web UI或者CLI(chimecli)发起迁移指令。也可以通过数据面发起，即通过chime-agent发起迁移指令，但通过chime-agent进行迁移通常是只是一种当管控面无法正常控制节点情况下，故障的运维手段，不是常规操作，非必要尽量不使用。
节点迁移过程中数据复制可以通过任意联通的网络完成，如果节点迁移是通过chime-server发起的，则迁移数据(内存拷贝)是通过"管理网"完成的; 如果节点迁移是通过chime-agent发起的，则可以选择网络网、业务网或者存储网(如果有)进行迁移数据。

### 通过Web UI迁移

在"**节点管理**"页面，选中要迁移的节点，在"**操作**"栏目中，点击"**迁移**"菜单项，弹出迁移选项页: 

{{% imgproc node_migrate Fit "700x400" %}}
节点迁移
{{% /imgproc %}}

其中选择以下选项开始迁移: 

- **目标节点**: 可选则一个目标节点，当前节点上的所有虚拟机都将迁移到目标节点，如果目标节点的资源(CPU,内存,存储)不足以安置全部的虚拟机，则迁移会失败。如果不选择目标节点，则系统会自动安排被迁移的虚拟机到集群内其它节点上。
- **迁移带本地盘的虚拟机**: 如果选中该选项，即使虚拟机包含本地硬盘，也会被一起迁移。需要注意的是，迁移带本地硬盘的虚拟机会消耗大量的网络带宽以及物理CPU等资源，而且耗时较长，迁移时间和本地硬盘实际使用的数据量大小成正比，因为迁移带本地盘的虚拟机，除了要进行内存拷贝，还需要将硬盘数据也一起拷贝。该选项默认不选中，即节点的迁移会忽略掉带本地硬盘的虚拟机。 

迁移执行后，节点的状态机会被锁定，迁移完成后节点的信息会被更新(节点虚拟机数量、迁移任务的执行情况等)。

### 通过chimecli迁移

### 通过chime-agent迁移


## 清空


## 重建

